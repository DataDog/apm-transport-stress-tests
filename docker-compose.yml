# Unless explicitly stated otherwise all files in this repository are licensed under the the Apache License Version 2.0.
# This product includes software developed at Datadog (https://www.datadoghq.com/).
# Copyright 2021 Datadog, Inc.

version: "2.4"
services:

  observer:
    image: datadog/docker-dd-agent
    links:
     - mockagent
     - spammer
    environment:
      - DD_API_KEY
      - DD_ENV
      - DD_LOG_LEVEL
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /proc/:/host/proc/:ro
      - /sys/fs/cgroup:/host/sys/fs/cgroup:ro
  
  mockagent:
    container_name: transport-mockagent
    image: transport-mockagent
    environment:
      - DD_APM_RECEIVER_PORT
      - DD_TRACE_AGENT_PORT
      - DD_DOGSTATSD_PORT
      - DD_APM_RECEIVER_SOCKET
      - DD_DOGSTATSD_SOCKET
      - DD_API_KEY
      - DD_ENV
      - DD_TEST_STALL_REQUEST_SECONDS
      - DD_LOG_LEVEL
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /proc/:/host/proc/:ro
      - /sys/fs/cgroup:/host/sys/fs/cgroup:ro
      - ./tmp/uds-volume/:/var/run/datadog
      - ./results/${TRANSPORT}/mockagent/snapshots:/snapshots
    ports:
      - "9126:9126/tcp"
      - "9125:9125/udp"
    cpu_count: 1
    cpus: 0.3
    cpu_percent: 10
    mem_limit: 50m
        
  spammer:
    container_name: transport-spammer
    image: transport-spammer
    environment:
      - DD_AGENT_HOST
      - DD_TRACE_AGENT_PORT
      - DD_APM_RECEIVER_PORT
      - DD_DOGSTATSD_PORT
      - DD_APM_RECEIVER_SOCKET
      - DD_DOGSTATSD_SOCKET
      - DD_TRACE_DEBUG
      - DD_ENV
      - DD_SERVICE
      - DD_VERSION
      - DD_LOG_LEVEL
    volumes:
      - ./results/${TRANSPORT}/logs/tracer:/var/log/datadog
      - ./tmp/uds-volume/:/var/run/datadog
    depends_on:
      - mockagent
    